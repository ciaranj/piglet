<div class="site-detail">
  @if (loading()) {
    <div class="loading">Loading site...</div>
  } @else if (site()) {
    <header class="page-header">
      <div>
        <a routerLink="/admin/sites" class="back-link">&larr; Back to Sites</a>
        <h1>{{ site()!.name }}</h1>
        <a [href]="site()!.path" target="_blank" class="site-path">{{ site()!.path }}</a>
      </div>
    </header>

    <div class="content-grid">
      <!-- Site Settings -->
      <section class="card">
        <h2>Site Settings</h2>
        <form (ngSubmit)="updateSite()">
          <div class="form-group">
            <label for="name">Site Name</label>
            <input id="name" type="text" [(ngModel)]="editName" name="name" required />
          </div>
          <div class="form-group">
            <label for="path">URL Path</label>
            <input id="path" type="text" [(ngModel)]="editPath" name="path" required
                   pattern="^/[a-zA-Z0-9/_.-]*$" />
          </div>
          <button type="submit" class="btn btn-primary" [disabled]="saving()">
            {{ saving() ? 'Saving...' : 'Save Changes' }}
          </button>
        </form>
      </section>

      <!-- Content Versions -->
      <section class="card">
        <div class="card-header">
          <div>
            <h2>Content Versions</h2>
            <p class="description">Manage uploaded content versions.</p>
          </div>
          <button class="btn btn-primary" (click)="openUploadModal()">
            Upload New Version
          </button>
        </div>

        @if (loadingVersions()) {
          <div class="loading-small">Loading versions...</div>
        } @else {
          <ul class="versions-list">
            @for (version of versions(); track version.id) {
              <li [class.active]="version.is_active">
                <div class="version-info">
                  <div class="version-header">
                    @if (version.is_active) {
                      <span class="badge active">Active</span>
                    }
                    <span class="version-date">{{ version.uploaded_at | date:'medium' }}</span>
                    <span class="version-size">{{ version.size_formatted }}</span>
                  </div>
                  @if (version.description) {
                    <div class="version-description">{{ version.description }}</div>
                  }
                </div>
                <div class="version-actions">
                  @if (!version.is_active) {
                    <button class="btn btn-small btn-primary" (click)="activateVersion(version)"
                            [disabled]="activatingVersion() === version.id">
                      {{ activatingVersion() === version.id ? 'Activating...' : 'Activate' }}
                    </button>
                    <button class="btn btn-small btn-danger" (click)="deleteVersion(version)"
                            [disabled]="deletingVersion() === version.id">
                      {{ deletingVersion() === version.id ? 'Deleting...' : 'Delete' }}
                    </button>
                  }
                </div>
              </li>
            } @empty {
              <li class="empty">No content versions uploaded yet.</li>
            }
          </ul>
        }
      </section>

      <!-- Authentication Settings -->
      <section class="card">
        <h2>Authentication</h2>
        <p class="description">Configure how users access this documentation.</p>

        <div class="access-toggle">
          <label class="toggle-option">
            <input type="radio" name="accessType" value="public"
                   [checked]="isPublic()"
                   (change)="setPublicAccess(true)" />
            <span class="toggle-label">
              <strong>Public</strong>
              <small>Anyone can view without logging in</small>
            </span>
          </label>
          <label class="toggle-option">
            <input type="radio" name="accessType" value="authenticated"
                   [checked]="!isPublic()"
                   (change)="setPublicAccess(false)" />
            <span class="toggle-label">
              <strong>Authenticated</strong>
              <small>Users must sign in to view</small>
            </span>
          </label>
        </div>

        @if (!isPublic()) {
          <div class="auth-methods">
            <h3>Authentication Methods</h3>
            <p class="description">Select one or more sign-in options for users.</p>

            <div class="auth-options">
              @for (option of authMethodOptions; track option.type) {
                <label class="auth-option">
                  <input type="checkbox"
                         [checked]="isAuthEnabled(option.type)"
                         (change)="toggleAuth(option.type, $event)" />
                  <span class="auth-label">
                    <strong>{{ option.label }}</strong>
                    <small>{{ option.description }}</small>
                  </span>
                </label>
              }
            </div>

            @if (isAuthEnabled('email')) {
              <div class="email-settings">
                <h3>Email Settings</h3>
                <div class="form-group">
                  <label for="flowType">Login Flow</label>
                  <select id="flowType" [(ngModel)]="emailFlowType" (change)="updateEmailSettings()">
                    <option value="magic_link">Magic Link (passwordless)</option>
                    <option value="register">Registration Required</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="domains">Allowed Domains (comma-separated, leave empty for any)</label>
                  <input id="domains" type="text" [(ngModel)]="emailDomains"
                         placeholder="company.com, partner.org"
                         (blur)="updateEmailSettings()" />
                </div>
              </div>
            }

            @if (authValidationError()) {
              <div class="validation-error">{{ authValidationError() }}</div>
            }
          </div>
        }

        <button class="btn btn-primary" (click)="saveAuthConfig()"
                [disabled]="savingAuth() || (!isPublic() && !hasAnyAuthMethod())">
          {{ savingAuth() ? 'Saving...' : 'Save Authentication Settings' }}
        </button>
      </section>

      <!-- Site Admins -->
      <section class="card">
        <h2>Site Admins</h2>
        <p class="description">Users who can upload content to this site.</p>

        <ul class="admin-list">
          @for (admin of siteAdmins(); track admin.id) {
            <li>
              <span>{{ admin.display_name || admin.email }}</span>
              <button class="btn btn-small btn-danger" (click)="removeSiteAdmin(admin.id)">
                Remove
              </button>
            </li>
          } @empty {
            <li class="empty">No site admins configured.</li>
          }
        </ul>

        <div class="add-admin">
          <select [(ngModel)]="selectedUserId" class="user-select">
            <option value="">Select an administrator...</option>
            @for (user of availableUsers(); track user.id) {
              <option [value]="user.id">
                {{ user.display_name || user.email }}
                @if (user.is_global_admin) {
                  (Global Admin)
                } @else if (user.site_admin_count > 0) {
                  (Site Admin)
                }
              </option>
            }
          </select>
          <button class="btn btn-secondary" (click)="addSiteAdmin()" [disabled]="!selectedUserId">
            Add Admin
          </button>
        </div>
      </section>
    </div>

    <!-- Upload Modal -->
    @if (showUploadModal()) {
      <div class="modal-overlay" (click)="closeUploadModal()">
        <div class="modal" (click)="$event.stopPropagation()">
          <div class="modal-header">
            <h2>Upload New Version</h2>
            <button class="modal-close" (click)="closeUploadModal()">&times;</button>
          </div>
          <div class="modal-body">
            @if (activeVersion()) {
              <div class="active-content-warning">
                <strong>Note:</strong> This site already has active content.
                Uploading will create a new version and switch to it.
              </div>
            }

            <div class="form-group">
              <label for="uploadDescription">Version Description</label>
              <input id="uploadDescription" type="text" [(ngModel)]="uploadDescription"
                     placeholder="e.g., v1.2.3 release, Bug fixes for API docs" />
              <small class="field-hint">Provide a description to help identify this version later.</small>
            </div>

            <div class="upload-area"
                 [class.dragover]="dragOver()"
                 [class.has-file]="selectedFile()"
                 (dragover)="onDragOver($event)"
                 (dragleave)="dragOver.set(false)"
                 (drop)="onDrop($event)">
              <input type="file" accept=".zip" (change)="onFileSelect($event)" #fileInput hidden />
              @if (uploading()) {
                <div class="upload-progress">
                  <div class="progress-bar">
                    <div class="progress-fill" [style.width.%]="uploadService.progress()?.percentage || 0"></div>
                  </div>
                  <span>{{ uploadService.progress()?.percentage || 0 }}%</span>
                </div>
              } @else if (selectedFile()) {
                <div class="selected-file">
                  <span class="file-icon">ðŸ“¦</span>
                  <span class="file-name">{{ selectedFile()!.name }}</span>
                  <span class="file-size">({{ formatFileSize(selectedFile()!.size) }})</span>
                  <button class="btn btn-small btn-secondary" (click)="clearSelectedFile(); fileInput.click()">
                    Change
                  </button>
                </div>
              } @else {
                <button class="btn btn-secondary" (click)="fileInput.click()">
                  Choose ZIP File
                </button>
                <p>or drag and drop</p>
              }
            </div>

            @if (uploadError()) {
              <div class="error-message">{{ uploadError() }}</div>
            }
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" (click)="closeUploadModal()" [disabled]="uploading()">
              Cancel
            </button>
            <button class="btn btn-primary" (click)="confirmUpload()"
                    [disabled]="!selectedFile() || uploading()">
              {{ uploading() ? 'Uploading...' : 'Upload & Activate' }}
            </button>
          </div>
        </div>
      </div>
    }
  } @else {
    <div class="error">Site not found</div>
  }
</div>
